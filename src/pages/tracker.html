<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f8ff; /* Light Blue */
        }
        .top-bar {
            background-color: #333;
            color: #fff;
            padding: 10px;
            text-align: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 999; /* Ensure top-bar is above other elements */
        }
        #map-container {
            position: relative;
            width: 80%; /* Adjust the width as needed */
            height: 500px; /* Adjust the height as needed */
            margin: 50px auto; /* Add margin to make space for top-bar */
            overflow: hidden; /* Hide overflow to prevent image from overflowing */
        }
        #santa {
            position: absolute;
            width: 50px;
            height: 50px;
            transition: left 0.5s ease, top 0.5s ease; /* Smooth transition for Santa's movement */
            cursor: pointer; /* Change cursor to pointer when hovering over Santa */
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div id="nextCityInfo"></div>
        <div id="lastCityInfo"></div>
    </div>
    
    <div id="map-container">
        <img id="santa" src="https://cdn.glitch.global/00096ffa-1c6f-46f0-aa52-09cd4de366d6/Santa_1-removebg-preview.png?v=1707774212144">
        <img id="map-image" width="100%" height="100%" src="https://cdn.glitch.global/00096ffa-1c6f-46f0-aa52-09cd4de366d6/satellite-map-of-the-world_wm00875.jpg?v=1707770779809">
    </div>

    <script>
        const nextCityInfo = document.getElementById('nextCityInfo');
        const lastCityInfo = document.getElementById('lastCityInfo');
        const santa = document.getElementById('santa');
        const mapImage = document.getElementById('map-image');
        const mapContainer = document.getElementById('map-container');

        const eventSource = new EventSource('/updates');

        let followingSanta = false;

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            updateTracker(data);
        };

        function updateTracker(data) {
            if (data.nextCity && data.timeLeft) {
                nextCityInfo.textContent = `Headed For: ${data.nextCity.country}, ${data.nextCity.city} in ${data.timeLeft} seconds.`;
            } else {
                nextCityInfo.textContent = '';
            }

            if (data.lastCity) {
                lastCityInfo.textContent = `Last Seen: ${data.lastCity.country}, ${data.lastCity.city}`;
            } else {
                lastCityInfo.textContent = '';
            }

            if (data.currentCity && data.currentCity.latitude && data.currentCity.longitude) {
                const { latitude, longitude } = data.currentCity;
                const { width, height } = mapImage.getBoundingClientRect();
                const x = (longitude + 180) * (width / 360);
                const y = (90 - latitude) * (height / 180);
                santa.style.left = `${x - 25}px`; // Adjust for the size of the Santa image
                santa.style.top = `${y - 25}px`; // Adjust for the size of the Santa image

                if (followingSanta) {
                    const containerRect = mapContainer.getBoundingClientRect();
                    const mapX = x - containerRect.width / 2;
                    const mapY = y - containerRect.height / 2;
                    mapContainer.scrollTo(mapX, mapY);
                }
            }
        }
// Function to handle SSE messages
    function handleSSE(event) {
        // Parse the event data
        const data = JSON.parse(event.data);
        
        // Check if the tracker has ended
        if (data.trackerEnded === true) {
            // Refresh the page to the home page if the tracker has ended
            window.location.href = '/';
        }
    }

    // Function to start listening for SSE messages
    function startSSE() {
        const eventSource = new EventSource('/updates');
        eventSource.onmessage = handleSSE;
    }

    // Start listening for SSE messages
    startSSE();
        santa.addEventListener('click', function() {
            followingSanta = !followingSanta;
            if (followingSanta) {
                santa.style.backgroundColor = 'yellow'; // Change color to indicate following
            } else {
                santa.style.backgroundColor = ''; // Remove background color
            }
        });

        mapContainer.addEventListener('wheel', function(event) {
            event.preventDefault();
            const zoomScale = event.deltaY > 0 ? 1.1 : 0.9; // Zoom in or out based on wheel direction
            mapContainer.style.width = `${mapContainer.offsetWidth * zoomScale}px`;
            mapContainer.style.height = `${mapContainer.offsetHeight * zoomScale}px`;
        });
    </script>
</body>
</html>
